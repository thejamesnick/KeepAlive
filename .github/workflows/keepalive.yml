name: KeepAlive Service

on:
  schedule:
    - cron: '10 0 * * 2,4' # Runs at 00:10 UTC on Tue/Thu
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check Database Health
        id: check_db
        run: |
          STATUS="failed"
          
          # 1. SUPABASE HEALTH CHECK
          # Requires: SUPABASE_URL and SUPABASE_PUBLISHABLE_KEY in GitHub Secrets
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_KEY="${{ secrets.SUPABASE_PUBLISHABLE_KEY }}"
          
          # Fallback to generic SUPABASE_KEY if PUBLISHABLE is missing
          if [ -z "$SUPABASE_KEY" ]; then
             SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}"
          fi

          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --request GET \
              --url "$SUPABASE_URL/auth/v1/health" \
              --header "apikey: $SUPABASE_KEY" \
            )
            if [ "$HTTP_CODE" -eq 200 ]; then STATUS="ok"; fi
          fi

          # 2. POSTGRES CONNECTION CHECK (DIRECT)
          if [ -n "${{ secrets.DATABASE_URL }}" ]; then
             if psql "${{ secrets.DATABASE_URL }}" -c "SELECT 1" > /dev/null 2>&1; then
               STATUS="ok"
             fi
          fi
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: Report to KeepAlive Dashboard
        if: always()
        run: |
          STATUS="${{ steps.check_db.outputs.status }}"
          if [ -z "$STATUS" ]; then STATUS="failed"; fi
          
          curl -s \
            --request POST \
            --url "${{ secrets.KEEPALIVE_ENDPOINT }}/api/ping" \
            --header "Content-Type: application/json" \
            --header "Authorization: Bearer ${{ secrets.KEEPALIVE_TOKEN }}" \
            --data "{\"project_id\": \"${{ secrets.KEEPALIVE_PROJECT_ID }}\", \"status\": \"$STATUS\"}"